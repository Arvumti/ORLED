var MoRow=Backbone.Model.extend(),CoGridList=Backbone.Collection.extend({url:"",initialize:function(){this.paginate={page:1,total:0,pageSize:10}},getMax:function(){return Math.ceil(this.paginate.total/this.paginate.pageSize)},init:function(e){var t=this,i=$.Deferred();console.log("Envio: "),console.log({data:this.paginate,aggregation:e});var a=[],o=e.specials;if(o)for(var s=0;s<o.length;s++){var n={field:o[s].field,to:"v"};"u"==o[s].to?n.to="u":o[s].value&&"function"==typeof o[s].value&&(n.value=o[s].value()),a.push(n)}else a=null;var l={selRow:e.selRow,selRows:e.selRows,dselRows:e.dselRows,tipo:e.tipo,order:e.order,filter:e.filter,specials:a},r=new Date;return $.getJSON(this.url,{data:this.paginate,aggregation:l},function(e){e.errmsg&&e.errmsg.length>0&&(app.ut.message({text:"Error en el grid, consulte al administrador del sistema"}),app.ut.logging({info:e,tipo:"grid",url:t.url}));var a=new Date;console.log("Tiempo de espuesta: "+(a-r)),console.log("Recibo: "),console.log(e),t.paginate.total=e.total,_.each(e.data,function(e){e[t.pk]=e[t.pk].toString(),t.add(new MoRow(e))}),i.resolve(e)}).fail(function(e){app.ut.message({text:"Error en el grid, consulte al administrador del sistema"}),app.ut.logging({xhr:e,tipo:"grid",url:t.url}),console.log(e)}),i},prev:function(e){var t={perform:!1,promise:null};return this.paginate.page--,0==this.paginate.page?this.paginate.page=1:(this.reset(),t.perform=!0,t.promise=this.init(e)),t},next:function(e){var t=this.getMax(),i={perform:!1,promise:null};return this.paginate.page++,this.paginate.page>t?this.paginate.page=t:(this.reset(),i.perform=!0,i.promise=this.init(e)),i},begin:function(e){var t={perform:!1,promise:null};return this.paginate.page>1&&(this.paginate.page=1,this.reset(),t.perform=!0,t.promise=this.init(e)),t},end:function(e){var t=this.getMax(),i={perform:!1,promise:null};return this.paginate.page<t&&(this.paginate.page=t,this.reset(),i.perform=!0,i.promise=this.init(e)),i}}),ViGrid=Backbone.View.extend({className:"bb-grid",events:{"click tfoot .gv-begin":"click_onBeing","click tfoot .gv-prev":"click_onPrev","click tfoot .gv-next":"click_onNext","click tfoot .gv-end":"click_onEnd","click tfoot .gv-all":"click_onAll","click tfoot .gv-none":"click_onNone","keypress tfoot .gv-pages":"keypress_onPages","keyup tfoot .gv-pages":"keyup_onPages","click thead .gv-order":"click_onOrder","click thead .gv-filter":"fake_event","keypress thead .gv-filter":"keypress_onFilter","keyup thead .gv-filter":"keyup_onFilter"},initialize:function(e){var t=this,i=[];this.totalWidth=0,_.each(e.columns||[],function(e){var a=_.defaults(e,{width:100});t.totalWidth+=a.width,i.push(a)}),this.totalWidth=(e.width||this.totalWidth)+20,this.$el.css({width:this.totalWidth});var a=_.defaults(e.command||{},{select:!1});this.config={columns:i,command:a,isComAct:a.select,extras:_.defaults(e.extras||{},{select:!1,primaryKey:null})},this.aggregates={selRow:null,selRows:[],dselRows:[],tipo:"none",order:[],filter:[],specials:e.specials||[]},this.fnTimeout=null,e.el&&this.setElement(e.el),this.$el.addClass(this.className);var o=this.config.columns.length+(this.config.isComAct?1:0);this.tagName=e.elem||"table";var s="";a.select&&(s='<div class="small-8 columns">                             <a class="gv-none" href="#"> Ninguno</a>                             <a class="gv-all" href="#"> Todos</a>                         </div>'),"div"==this.tagName?(this.className="ui-grid",this.$el.html('<section class="thead"></section><section class="tbody"></section><section class="tfoot"><article><div></div></article></section>'),this.head=this.$el.children(".thead"),this.body=this.$el.children(".tbody"),this.tfoot=this.$el.children(".tfoot"),this.tfoot.css({width:this.totalWidth-20}),this.tmpHead=Handlebars.compile('<article>{{#columns}}<div style="width:{{width}}px">{{nombre}}</div>{{/columns}}</article>'),this.tmpBody=Handlebars.compile('{{#rows}}<article>{{#.}}<div style="width:{{width}}px">{{GetValue .}}</div>{{/.}}</article>{{/rows}}')):(this.$el.html('<thead></thead><tbody></tbody><tfoot><tr><td colspan="'+o+'" class="gv-pager row">                             <div class="small-4 columns">                                 <a class="gv-begin" href="#"></a>                                <a class="gv-prev" href="#"></a>                                <input type="text" class="gv-pages" value="1" /> <strong><span>/</span> <span class="gv-max">1</span></strong>                                 <a class="gv-next" href="#"></a>                                <a class="gv-end" href="#"></a>                            </div> '+s+"                                                                                    </td></tr></tfoot>"),this.head=this.$el.children("thead"),this.body=this.$el.children("tbody"),this.tfoot=this.$el.children("tfoot"),this.tmpHead=Handlebars.compile('<tr>{{#if isComAct}}<th class="gv-col-command"></i></th>{{/if}}{{#columns}}<th style="width:{{width}}px" data-field="{{field}}" class="gv-order"><strong><span>{{nombre}} </span><input type="text" class="gv-filter"/></strong></th>{{/columns}}</tr>'),this.tmpBody=Handlebars.compile('{{#rows}}<tr data-pkey="{{key}}" data-cid="{{cid}}">                                                     {{#if command.select}}<td class="col-command"><input type="checkbox"/></td>{{/if}}                                                     {{#data}}<td>{{GetValue .}}</td>{{/data}}                                                 </tr>{{/rows}}')),Handlebars.registerHelper("GetValue",function(e){if("date"==e.type){if(!e.value)return"";if(-1==e.value.search(/[a-zA-Z]+/))return e.value;var t=new Date(e.value.toString()),i=t.getDate().toString(),a=(parseInt(t.getMonth().toString())+1).toString(),o=t.getFullYear().toString();e.value=(1==i.length?"0"+i:i)+"-"+(1==a.length?"0"+a:a)+"-"+o}else"string"==typeof e.value&&(e.value=e.value.replace(/&amp;/g,"&"),e.value=e.value.replace(/&gt;/g,">"),e.value=e.value.replace(/&lt;/g,"<"),e.value=e.value.replace(/&quot;/g,'"'),e.value=e.value.replace(/&apos;/g,"'"),e.value=e.value.replace(/#35;/g,"#"));return e.value}),this.config.extras.primaryKey||(this.config.isComAct=!1,this.config.command.select=!1),this.config.command.select&&(this.events['click tbody tr .col-command input[type="checkbox"]']="click_onSelect"),this.config.extras.select&&(this.events["click tbody tr"]="click_onTr"),this.collection=new CoGridList,this.collection.model=e.model,this.collection.url=e.url||"/",this.collection.pk=this.config.extras.primaryKey||null;var n=this.collection.init(this.aggregates);n.then(function(e){t.render(e)}),this.head.html(this.tmpHead(this.config))},getDataRow:function(e){for(var t=_.extend([],this.config.columns),i={key:e.get(this.config.extras.primaryKey),cid:e.cid,data:[],command:this.config.command},a=0;a<t.length;a++){var o=null;if(-1==t[a].field.indexOf("."))o=e.get(t[a].field);else{var s=t[a].field.split(".");o=e.get(s[0])[s[1]]}i.data.push({value:o,type:this.config.columns[a].type||"none"})}return[i]},render:function(e){for(var t=[],i=_.extend([],this.config.columns),a=0;a<this.collection.length;a++){for(var o=this.collection.at(a),s={key:o.get(this.config.extras.primaryKey),cid:o.cid,data:[],command:this.config.command},n=0;n<i.length;n++){var l=null;if(-1==i[n].field.indexOf("."))l=o.get(i[n].field);else{var r=i[n].field.split(".");l=o.get(r[0])[r[1]]}s.data.push({value:l,type:this.config.columns[n].type||"none"})}t.push(s)}var c=this.body.html(this.tmpBody({rows:t}));return this.tfoot.find(".gv-max").text(this.collection.getMax()),this.tfoot.find(".gv-pages").val(this.collection.paginate.page),this.aggregates.selRows=[],this.aggregates.dselRows=[],e.aggregation&&(this.aggregates.selRow=e.aggregation.selRow,"all"==this.aggregates.tipo?(_.each(c.find('tr input[type="checkbox"]'),function(e){e.click()}),_.each(_.unique(e.aggregation.dselRows),function(e){c.find('tr[data-pkey="'+e+'"] input[type="checkbox"]').click()})):_.each(_.unique(e.aggregation.selRows),function(e){c.find('tr[data-pkey="'+e+'"] input[type="checkbox"]').click()})),this},click_onSelect:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget).parents("tr");t.toggleClass("isMultiSelected");var i=t.data("cid"),a=this.collection.get(i),o=a.get(this.config.extras.primaryKey).toString();if(e.currentTarget.checked){var s=this.aggregates.dselRows.indexOf(o);s>-1&&this.aggregates.dselRows.splice(s,1),this.aggregates.selRows.push(o)}else{var s=this.aggregates.selRows.indexOf(o);s>-1&&(this.aggregates.selRows.splice(s,1),this.aggregates.dselRows.push(o))}},click_onTr:function(e){e.preventDefault(),e.stopPropagation(),this.body.children(".isSelected").removeClass("isSelected");var t=$(e.currentTarget);t.addClass("isSelected");var i=this.collection.get(t.data("cid"));this.aggregates.selRow=i.toJSON()},click_onBeing:function(e){e.preventDefault(),e.stopPropagation();var t=this,i=this.collection.begin(this.aggregates);i.perform&&i.promise.then(function(e){t.render(e)})},click_onPrev:function(e){e.preventDefault(),e.stopPropagation();var t=this,i=this.collection.prev(this.aggregates);i.perform&&i.promise.then(function(e){t.render(e)})},click_onNext:function(e){e.preventDefault(),e.stopPropagation();var t=this,i=this.collection.next(this.aggregates);i.perform&&i.promise.then(function(e){t.render(e)})},click_onEnd:function(e){e.preventDefault(),e.stopPropagation();var t=this,i=this.collection.end(this.aggregates);i.perform&&i.promise.then(function(e){t.render(e)})},click_onAll:function(e){e.preventDefault(),e.stopPropagation(),this.aggregates.tipo="all",_.each(this.body.find('tr input[type="checkbox"]'),function(e){e.checked||$(e).click()}),this.aggregates.dselRows=[]},click_onNone:function(e){e.preventDefault(),e.stopPropagation(),this.aggregates.tipo="none",_.each(this.body.find('tr input[type="checkbox"]'),function(e){e.checked&&$(e).click()}),this.aggregates.selRows=[]},keypress_onPages:function(e){var t=this,i=e.which||e.keyCode||e.charCode,a=1e3;13==i&&(a=0),13==i||i>=48&&57>=i?(clearTimeout(this.fnTimeout),this.fnTimeout=setTimeout(function(){console.log("launch");var i=$(e.currentTarget).val().toInt(1),a=t.collection.getMax(),o=t.collection.paginate.page;if(i>a)i=a;else if(0>=i)i=1;else if(i==o)return void $(e.currentTarget).val(i);t.collection.reset(),t.collection.paginate.page=i;var s=t.collection.init(t.aggregates);s.then(function(e){t.render(e)})},a)):e.preventDefault()},keyup_onPages:function(e){var t=e.which||e.keyCode||e.charCode;console.log(t),(8==t||48==t)&&(e.which=48,this.keypress_onPages(e))},click_onOrder:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget),i=t.data("field"),a={field:i};if(t.parents("tr").find("th").removeClass("gv-desc gv-asc"),this.aggregates.order.field==i){var o=this.aggregates.order;switch(o.orden){case 1:o.orden=-1,t.addClass("gv-asc");break;case-1:o.orden=0;break;default:o.orden=1,t.addClass("gv-desc")}}else a.orden=1,this.aggregates.order=a,t.addClass("gv-desc");this.collection.reset(),this.collection.paginate.page=1;var s=this,o=this.collection.init(this.aggregates);o.then(function(e){s.render(e)})},keypress_onFilter:function(e){var t=this,i=e.which||e.keyCode||e.charCode;console.log(i);var a=1e3;13==i&&(a=0),13==i||i>=32&&122>=i||209==i||241==i||193==i||201==i||205==i||211==i||218==i||225==i||233==i||237==i||243==i||250==i?(clearTimeout(this.fnTimeout),this.fnTimeout=setTimeout(function(){console.log("laun filtro");var i=$(e.currentTarget),a=i.parents("th").data("field"),o={field:a},s=_.findWhere(t.aggregates.filter,o);void 0===s?(o.query=i.val(),t.aggregates.filter.push(o)):s.query=i.val(),t.collection.reset(),t.collection.paginate.page=1;var s=t.collection.init(t.aggregates);s.then(function(e){t.render(e)})},a)):e.preventDefault()},keyup_onFilter:function(e){var t=e.which||e.keyCode||e.charCode;console.log(t),(8==t||48==t)&&(e.which=48,this.keypress_onFilter(e))},fake_event:function(e){e.stopPropagation()},addTR:function(e){this.collection.add(e);var t=this.getDataRow(e),i=this.tmpBody({rows:t});this.body.prepend(i)},modifyTR:function(e){var t={};t[this.config.extras.primaryKey]=e[this.config.extras.primaryKey];var i=this.collection.findWhere(t);i.set(e);var a=this.getDataRow(i),o=this.tmpBody({rows:a}),s=this.body.find('[data-cid="'+i.cid+'"]');s.html($(o).html())}});define([],function(){app.models.moRow=MoRow,app.collections.coGrid=CoGridList,app.controles.grid=ViGrid});