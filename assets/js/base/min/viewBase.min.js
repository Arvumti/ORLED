var ViBase=Backbone.View.extend({getData:function(e,t,a){var i='[data-field]:not(table [data-field], .tt-hint, [type="radio"]),[data-field][type="radio"]:checked';"table"==a&&(i="[data-field]:not(.tt-hint)");for(var n=e.find(i),o={},l=0;l<n.length;l++){var r=n.eq(l),s=null;if(r.hasClass("tya")){var d=r.data("current");o["dKey"+r.data("field")]=null,d&&(s=d[r.data("field")],o["dKey"+r.data("field")]=d[r.data("dKey")])}else if(r.hasClass("date"))s=r.val();else if(r.hasClass("table")){var c=r.find("tbody tr"),h=o[r.data("field")],f=h instanceof Array;s=f?h:Array();for(var p=0;p<c.length;p++)s.push(ViBase.prototype.getData.call(this,c.eq(p),!0,"table"));if(f)continue}else s=r.hasClass("upload")?r.data("fn").getUrl():"checkbox"==r[0].type?r.prop("checked")?1:0:"SPAN"==r.prop("nodeName")?r.data("value")||r.text():r.val();o[r.data("field")]=s}return o},setData:function(e,t,a){for(var i in e){var n='[data-field="'+i+'"]:not(table [data-field], .tt-hint)';"table"==a&&(n='[data-field="'+i+'"]:not(span, .tt-hint)');var o=t.find(n);if(o.length>0)if(o.hasClass("tya")){var l={};l[i]=e[i],l[i]?(l.nombre=e["dKey"+i],l.dKey=e["dKey"+i],o.data("current",l).val(l.dKey).blur()):o.data("current",null).val("").blur()}else if(o.hasClass("date")){var r=new Date(e[i]);if("Invalid Date"==r)o.val(e[i]);else{var s=r.getDate().toString(),d=(parseInt(r.getMonth().toString())+1).toString(),c=r.getFullYear().toString(),h=(1==s.length?"0"+s:s)+"-"+(1==d.length?"0"+d:d)+"-"+c;o.val(h)}}else if(o.hasClass("table")){var f=o.data("setlink"),p=e;if(f){var u=o.data("setwhere");p[o.data("field")]=_.filter(p[o.data("field")],function(e){return e[f].toString()==u.toString()})}var v=o.find("tbody tr"),m=p[o.data("field")],g=m instanceof Array;if(g&&0==m.length)continue;for(var k=(m.length,v.length),b=0;b<m.length&&!(b>k);b++)ViBase.prototype.setData.call(this,m[b],v.eq(b),"table")}else o.hasClass("upload")?e[i]&&o.data("fn").setUrl(e[i]):"checkbox"==o[0].type?o.prop("checked",e[i].toString().toInt()):"object"==typeof e[i]?o.val(""):o.val(e[i])}},linkRemote:function(e,t){for(var a=Object(),i=0;i<e.length;i++){var n=e.eq(i),o=n.data("up-field"),l=t[o];l.elem=n,app.ut.uploadRemote(l),a[o]=n}return a}}),ViABC=Backbone.View.extend({initialize:function(e,t,a){this.gvDatosEl=this.$el.find(".gvDatos"),this.model||(this.model=app.models.moRow),this.extras||(this.extras={locked:[],clean:[]});var i={select:!1},n={select:!0,primaryKey:this.pk};this.gvGrid=new app.controles.grid({model:this.model,columns:e,command:i,extras:n,specials:a,url:"/controles/grid"+this.url,el:this.gvDatosEl}),this.tbody=this.gvDatosEl.children("tbody"),t||(this.popSave=this.$el.find(".modal-save"),this.popAction=new ViPopSaveABC({url:this.url,pk:this.pk,parentView:this,el:this.popSave})),this.events["click .btn-nuevo"]="click_nuevo",this.events["click .btn-modificar"]="click_modificar",this.events["click .btn-eliminar"]="click_eliminar",this.$el.foundation()},render:function(e){this.$el.removeClass("isHidden")},addRow:function(e){switch(e.crud){case 1:for(var t in e)e[t]=(e[t]||"").toString();var a=new this.model(e);this.gvGrid.addTR(a);break;case 2:this.gvGrid.modifyTR(e)}},close:function(){this.$el.addClass("isHidden")},click_nuevo:function(){this.popAction.render({crud:1})},click_modificar:function(){var e=this.tbody.find(".isSelected");if(0==e.length)app.ut.message({text:"Tiene que seleccionar un registro",tipo:"warning"});else{var t=this.gvGrid.collection.get(e.data("cid"));this.popAction.render({crud:2,model:t})}},click_eliminar:function(){var e=this,t=this.tbody.find(".isSelected");if(0==t.length)app.ut.message({text:"Tiene que seleccionar un registro",tipo:"warning"});else{var a=this.gvGrid.collection.get(t.data("cid"));popConfirm.render(function(){function i(i){popConfirm.click_cancelar(),e.gvGrid.collection.remove(a,{silent:!0}),t.remove()}app.ut.request({url:e.url+"/"+t.data("pkey"),data:{model:a.toJSON()},done:i,type:"DELETE"})})}}}),ViPopSaveABC=Backbone.View.extend({events:{"click .btn-aceptar":"click_aceptar","click .btn-cancelar":"click_cancelar"},initialize:function(e){var t=this;this.on_save=!1,this.modelBase=new e.parentView.model,this.mode={SaveAndContinue:!1,getPlantel:!1,upload:!1},this.parentView=e.parentView,this.url=e.url,this.form=this.$el.find("form"),this.thead=this.$el.children(".pop-head"),this.tbody=this.$el.children(".pop-body"),this.crud=1,this.pk=e.pk,this.form.find(".date").fdatepicker({format:"dd-mm-yyyy"});var a=this.form.find(".tya");this.linkFks(a,this.parentView.fks),this.$el.find(".tya.tt-hint").removeAttr("required"),this.form.on("valid",function(e){e.preventDefault(),t.save()}).on("submit",function(e){e.preventDefault()});var i=this.form.find(".upload");this.uploads=Object();for(var n=0;n<i.length;n++){var o=i.eq(n);app.ut.upload({elem:o}),this.uploads[o.data("field")]=o}},linkFks:function(e,t,a){var i;i=a?Object():this.tyas=Object();for(var n=0;n<e.length;n++){var o=t[e.eq(n).data("field")];o&&(app.ut.tyAhead({elem:e.eq(n),url:o.url,filters:o.filters,sorts:o.sorts,where:o.where,dKey:o.dKey,done:o.done,onSelected:o.onSelected,onClean:o.onClean,custom:o.custom,def:o.def}),i["tya"+e.eq(n).data("field")]=e.eq(n))}return e.find(".tt-hint").removeAttr("required"),i},render:function(e){if(this.model=e.model,this.crud=e.crud||1,this.clear(),2==this.crud){this.setData(this.model.toJSON()||{});for(var t=this.parentView.extras.locked||[],a=0;a<t.length;a++){var i=this.$el.find('[data-field="'+t[a]+'"]');i.attr("disabled","disabled")}}this.$el.foundation("reveal","open")},clear:function(){if(this.form[0].reset(),this.$el.find("[data-field]").removeAttr("disabled"),this.$el.find(".tya-clear").click(),this.mode.upload)for(var e in this.uploads)this.uploads[e].data("fn").clean()},clean:function(){var e=this.parentView.extras.clean;if(0!=e.length)for(var t=0;t<e.length;t++){var a=this.$el.find('[data-field="'+e[t]+'"]');a.hasClass("tya")?a.data("fn").clean():"SELECT"==a.prop("nodeName")?a.find("option:first").prop("selected",!0):"checkbox"==a.prop("type")?a.prop("checked",!1):a.val("")}},getData:function(){var e=ViBase.prototype.getData.call(this,this.form);return this.mode.getPlantel&&(e.idPlantel={to:"u"}),e},setData:function(e){ViBase.prototype.setData.call(this,e,this.form)},save:function(){function e(e){return t.on_save=!1,e.errmsg&&e.errmsg.length>0?(app.ut.message({text:e.errmsg}),!1):(t.mode&&t.mode.SaveAndContinue&&1==t.crud?t.clean():t.click_cancelar(t),e.crud=t.crud,void t.parentView.addRow(e))}var t=this,a=t.getData(),i="POST",n=this.url;2==this.crud?(i="PUT",n+="/"+this.model.get(this.pk),_.defaults(a,this.model.attributes)):_.defaults(a,this.modelBase.defaults);var o;this.mode.upload&&(o=this.form),app.ut.request({url:n,data:a,done:e,type:i,form:o})},click_aceptar:function(){this.form.submit()},click_cancelar:function(){this.$el.foundation("reveal","close")},keyup_pop:function(e){console.log(e),e.stopPropagation(),13!=(e.keyCode?e.keyCode:e.which)||this.on_save||(this.on_save=!0,this.form.submit())}}),ViPopConfirmacion=Backbone.View.extend({el:"#popConfirmacion",events:{"click .btn-cancelar":"click_cancelar"},initialize:function(){this.btnAceptar=this.$el.find(".btn-aceptar")},render:function(e){this.btnAceptar.off("click").on("click",e),this.$el.foundation("reveal","open")},click_cancelar:function(){this.$el.foundation("reveal","close")}}),popConfirm=new ViPopConfirmacion;define(["base","controles"],function(e,t){return{abc:ViABC,popAbc:ViPopSaveABC,base:ViBase,confirm:popConfirm}});