var ViBody=Backbone.View.extend({el:"body",events:{"click nav ul.menu-n1 > li > a":"click_menun1","click nav ul.menu-n2 > li > a":"click_menun2","click .profile, .wrap-layer":"click_open_menu","keyup .txtBusqueda":"keyup_txtBusqueda","click .login":"click_open_login","click .help":"click_help","click .btn-login":"click_login","click .info-plantel":"click_plantel","click .tituloChat":"click_chatOpenClose","click .chat-user":"click_chats","click .closeVentana":"click_closeChat","click .closetitulo":"click_closeChatTitulo","click div .inactive":"click_OpenNewChat","click div .tituloChat-custom label":"click_ChangeChat","click .chatButonShowHide":"showHideChatComplete","keyup .chatOpen textarea":"keyup_message","keyup .buscarChat":"keyup_search"},initialize:function(){this.user=null,this.txtBusqueda=this.$el.find(".txtBusqueda"),this.infoUser=this.$el.find("section.info-user"),this.lblUsuario=this.$el.find(".lblUsuario"),this.infoPlantel=this.infoUser.find(".info-plantel"),this.infoPeriodo=this.infoUser.find(".info-periodo"),this.ventanas=0,this.popLogin=this.$el.find("#popLogin.popLogin"),this.popPlanteles=new ViPlantelesUs({parentView:this}),this.txtUsuario=this.popLogin.find(".txtUsuario"),this.txtPassword=this.popLogin.find(".txtPassword"),this.joyrIndex=this.$el.find(".joyride-index"),this.ventanaChat=this.$el.find(".chatOpen"),this.buscarChat=this.$el.find(".buscarChat"),this.messageNotMatch=this.$el.find(".userNotMatch"),this.checkLogin(),this.gvChat=this.$el.find(".gvChat"),this.fullChat=this.$el.find(".chat"),this.gvChatExtra=this.$el.find(".chatOpenHide"),this.gvChatZone=this.$el.find(".gvChatZone"),this.gvNumChat=this.$el.find(".numChat"),this.chatOpenHide=this.$el.find(".chatHiddenTitulo"),this.tmp_div_chat=Handlebars.compile(this.$el.find(".tmp_div_chat").html()),this.tmp_div_chatuser=Handlebars.compile(this.$el.find(".tmp_div_chatuser").html()),this.tmp_div_chatuserHide=Handlebars.compile(this.$el.find(".tmp_div_chatuserHide").html()),this.tmp_frm_noaccess=Handlebars.compile(this.$el.find(".tmp_frm_noaccess").html()),this.$el.find(".date").fdatepicker({format:"dd-mm-yyyy"})},logout:function(e){window.location.href="/sesiones/logout"},login:function(e,t){function i(e){e.errmsg&&e.errmsg.length>0?app.ut.message({text:"El usuario y/o la contraseña no son correctos"}):(a.user=e,app.router.navigate("#",{trigger:!0,replace:!0}),a.lblUsuario.text(e.usuario),a.infoPlantel.text(e.clave+" - "+e.nombrePlantel),a.render_menu(e),a.popLogin.foundation("reveal","close"))}var a=this,n={user:e||"admin",pass:t||"admin"};app.ut.request({url:"/sesiones/login",data:n,done:i})},getCurrPlantel:function(){var e=_.findWhere(this.user.planteles,{idPlantel:this.user.idPlantel.toString()});return e},getIdPlantel:function(){return this.user.idPlantel},checkLogin:function(){var e=this.$el.find(".is-used-user");this.user=e.data("info"),e.remove(),app.ut.request({url:"/sesiones/getUser",done:function(e){e||(window.location.href="/sesiones/logout")}})},render_menu:function(e){var t=Handlebars.compile($(".tmp_ul_menus_bs").html())(e);t=$("ul.menu-n1").html(t),$("ul.search-n1").addClass("isHidden").html(t.find(".menu-n2 li").clone())},usersChat:function(e){if(e){var t=this.tmp_div_chat({usuarios:e.data});this.gvChat.html(t),this.gvChat.append('<div class="chat-user isHidden userNotMatch"><i class="icon-search"></i><label> No existen resultados</label></div>')}},messageChat:function(e){var t=this.gvChatZone.find('[data-idusuario="'+e.from+'"]');if(0==t.length){if(uschat=this.gvChat.find('[data-idusuario="'+e.from+'"]'),0==uschat.length)return;uschat.click(),this.gvChatZone.find(".chatOpen").length>2&&(t=this.gvChatZone.find('[data-idusuario="'+e.from+'"]'))}t.hasClass("tituloChat-custom")&&t.find("label").click(),t=this.gvChatZone.find('[data-idusuario="'+e.from+'"]').parent(".chatOpen").find(".message"),t.append('<p class="partner"><label class="mensaje">'+e.message+'</label><label class="triangulo"></label></p>').animate({scrollTop:t[0].scrollHeight})},onlineUserChat:function(e){if(e)for(var t=this,i=e.users.length-1;i>=0;i--){var a=e.users[i];if(a!=t.user.idUsuario){var n=this.gvChat.find('[data-idusuario="'+a+'"]');n.find("i.icon-punto").removeClass("offline").addClass("online")}}},offlineUserChat:function(e){var t=this.gvChat.find('[data-idusuario="'+e+'"]');t.find("i.icon-punto").removeClass("online").addClass("offline")},"export":function(e){function t(e){window.open("/impresion/imprimir","Documento","menubar=No,resizable=No,width=500,height=30")}var i=e.elem.clone(),a=i.html();app.ut.request({url:"/impresion/prepare",data:{html:a},done:t,type:"POST"})},print:function(e){this.$el.find(".pnl-print").html(e.elem.html()),window.print()},css:function(e){var t=document.styleSheets,i={};for(var a in t){var n=t[a].rules||t[a].cssRules;for(var s in n)e.is(n[s].selectorText)&&(i=$.extend(i,this.css2json(n[s].style),this.css2json(e.attr("style"))))}return i},css2json:function(e){var t={};if(!e)return t;if(e instanceof CSSStyleDeclaration)for(var i in e)e[i].toLowerCase&&(t[e[i].toLowerCase()]=e[e[i]]);else if("string"==typeof e){e=e.split("; ");for(var i in e){var a=e[i].split(": ");t[a[0].toLowerCase()]=a[1]}}return t},click_plantel:function(e){e.preventDefault(),this.popPlanteles.render(this.user.planteles)},resetInput:function(){this.buscarChat.val(""),this.gvChat.find("label").parents(".chat-user").removeClass("isHidden"),this.gvChat.find("label").parents(".userNotMatch").addClass("isHidden")},keyup_search:function(e){var t=this.buscarChat.val();if(t){this.gvChat.find("label:not(:contains("+t+"))").parents(".chat-user").addClass("isHidden");var i=this.gvChat.find("label:contains("+t+")").parents(".chat-user");0==i.length&&this.gvChat.find("label").parents(".userNotMatch").removeClass("isHidden")}else this.gvChat.find("label").parents(".chat-user").removeClass("isHidden"),this.gvChat.find("label").parents(".userNotMatch").addClass("isHidden")},keyup_message:function(e){if(13==e.which){var t=$(e.currentTarget),i=t.val(),a=(t.parents(".chatOpen").find(".tituloChat").data("idusuario"),t.parents(".chatOpen").find(".message"));i.trim().length>0&&(a.append('<p class="me"><label class="triangulo"></label><label class="mensaje">'+String(i).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")+"</label></p>").animate({scrollTop:a[0].scrollHeight}),t.val("")),t.val("")}},click_chatOpenClose:function(e){var t=$(e.currentTarget).parents("div .chatOpen");t.toggleClass("close")},showHideChatComplete:function(e){var t=this,i=$(e.currentTarget);i.toggleClass("active"),t.fullChat.toggleClass("isHidden"),t.gvChatZone.toggleClass("isHidden")},click_closeChat:function(e){var t=this,i=$(e.currentTarget).parents("div .chatOpen");$(e.currentTarget).parents("div .tituloChat");i.remove();var a=t.chatOpenHide.find(".tituloChat-custom").length;if(t.ventanas--,a>0&&t.ventanas<3){var n=t.gvChatExtra.find(".tituloChat-custom:first").remove();a=t.chatOpenHide.find(".tituloChat-custom").length,t.gvNumChat.text("("+a+")");var s=n.data("idusuario"),l=n.data("nombre"),o=this.tmp_div_chatuser({idUsuario:s,nombre:l});t.ventanas++,t.gvChatZone.prepend(o)}t.gvNumChat.text("("+a+")"),0==a&&t.gvChatExtra.addClass("isHidden")},click_closeChatTitulo:function(e){var t=this,i=$(e.currentTarget).parents("div .tituloChat-custom");i.remove();var a=t.chatOpenHide.find(".tituloChat-custom").length;t.gvNumChat.text("("+a+")"),0==a&&t.gvChatExtra.addClass("isHidden")},click_ChangeChat:function(e){var t=this,i=t.gvChatZone.find(".tituloChat:first");t.gvChatZone.find(".chatOpen:first").remove();var a=i.data("idusuario"),n=i.data("nombre"),s=this.tmp_div_chatuserHide({idUsuario:a,nombre:n});t.chatOpenHide.append(s);var l=$(e.currentTarget).parent("div").remove(),a=l.data("idusuario"),n=l.data("nombre"),s=this.tmp_div_chatuser({idUsuario:a,nombre:n});t.gvChatZone.prepend(s)},click_OpenNewChat:function(e){var t=this,i=$(e.currentTarget).data("idusuario"),a=$(e.currentTarget).data("nombre");if(0==t.gvChatZone.find('[data-idusuario="'+i+'"]').length&&t.ventanas<3){var n=this.tmp_div_chatuser({idUsuario:i,nombre:a});t.ventanas++,t.gvChatZone.prepend(n)}else if(0==t.chatOpenHide.find('[data-idusuario="'+i+'"]').length&&t.ventanas>2&&0==t.gvChatZone.find('[data-idusuario="'+i+'"]').length){var n=this.tmp_div_chatuserHide({idUsuario:i,nombre:a});t.chatOpenHide.append(n);var s=t.chatOpenHide.find(".tituloChat-custom").length;t.gvNumChat.text("("+s+")"),t.gvChatExtra.removeClass("isHidden")}},click_open_login:function(e){e.preventDefault(),this.popLogin.foundation("reveal","open")},click_help:function(e){e.preventDefault(),this.joyrIndex.foundation("joyride","start")},click_login:function(e){this.login(this.txtUsuario.val(),this.txtPassword.val())},click_menun1:function(e){var t=$(e.currentTarget).parents("li");t.siblings("li.isActive").removeClass("isActive").children("ul.menu-n2").slideToggle().children("li.isActive").removeClass("isActive"),t.hasClass("has-submenu")&&(e.preventDefault(),t.hasClass("isActive"))||t.addClass("isActive").children("ul.menu-n2").slideToggle()},click_menun2:function(e){var t=$(e.currentTarget).parents("li");t.siblings("li.isActive").removeClass("isActive"),t.addClass("isActive")},click_open_menu:function(e){$("nav, main, .wrap-layer").toggleClass("is-menu-open"),$("nav, main, .wrap-layer").hasClass("is-menu-open")&&(this.txtBusqueda.val(""),this.keyup_txtBusqueda({currentTarget:this.txtBusqueda}))},keyup_txtBusqueda:function(e){var t=$(e.currentTarget).val();if(t.length>0){$("ul.menu-n1").addClass("isHidden"),$("ul.search-n1").removeClass("isHidden");var i=$('ul.search-n1 li:not(:contains("'+t+'"))');$("ul.search-n1 li").removeClass("isHidden"),i.addClass("isHidden")}else $("ul.menu-n1").removeClass("isHidden"),$("ul.search-n1").addClass("isHidden")}}),ViPlantelesUs=Backbone.View.extend({el:"#popPlanteles",events:{"click .blk-grupo":"click_plantel"},initialize:function(e){this.plateles=Handlebars.compile($(".tmp_plateles_bs").html()),this.body=this.$el.find(".modal-body")},close:function(){this.$el.foundation("reveal","close")},render:function(e){var t=this.plateles({planteles:e});this.body.html(t),this.$el.foundation("reveal","open")},click_plantel:function(e){var t=$(e.currentTarget).data("id"),i=$(e.currentTarget).data("clave"),a=$(e.currentTarget).data("nombre"),n=this;app.ut.request({url:"/sesiones/setPlantel",data:{idPlantel:t,clave:i,nombrePlantel:a},done:function(e){n.options.parentView.infoPlantel.text(i+" - "+a),n.options.parentView.user=e,n.close(),location.reload()}})}});define([],function(){function e(){var n=i-t;return console.log("dateDiff: ",n),0==n?void(window.location.href="/sesiones/logout"):(t=new Date,i=new Date,void setTimeout(e,a))}$(document).foundation({reveal:{close_on_background_click:!1,multiple_opened:!0},abide:{patterns:{curp:/^[a-zA-Z]{4}[0-9]{6}[m|h|M|H][a-zA-Z]{2}[a-zA-Z]{3}[a-zA-Z0-9][0-9]$/,decimales:/^[0-9]+(\.[0-9][0-9]?)?$/,numeros:/^[0-9]+$/,horas:/^[0-9]{2}\:[0-9]{2}$/,string:/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+$/,clave:/^[A-Z\d]+$/,email:/^[\w\-\.]+@[a-zA-Z_]+?\.[a-zA-Z]{2,3}(\.[a-zA-Z]{2,3})?$/,rfc:/^([A-Z,Ñ,&]{3,4}([0-9]{2})(0[1-9]|1[0-2])(0[1-9]|1[0-9]|2[0-9]|3[0-1])[A-Z|\d]{3})$/}}}),$(document).foundation("reflow"),app.views.main=new ViBody;var t=new Date,i=new Date,a=9e5;return setTimeout(e,a),$(document).mousemove(function(e){i=new Date}),$(document).keypress(function(e){i=new Date}),window.onbeforeunload=function(e){console.log("logout before")},window.onunload=function(e){console.log("logout unload")},app});