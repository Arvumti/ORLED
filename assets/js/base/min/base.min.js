function readURL(e,t){if(e.files&&e.files[0]){var n=new FileReader;n.onload=function(e){e.total>6e4?app.ut.message({text:"La imagen no puede ser mayor a 60 KB",tipo:"warning"}):t.data("old","old").attr("src",e.target.result)},n.readAsDataURL(e.files[0])}}function fueraDeServicio(){app.ut.message({text:"El sistema esta siendo actualizado, puede que algunas areas del sistema esten fallando.",tipo:"warning"})}function bases(){jQuery.expr[":"].contains=function(e,t,n){var a=void 0===n[3]?"":n[3];return jQuery(e).text().toUpperCase().indexOf(a.toUpperCase())>=0},jQuery.fn.extend({doFocus:function(){var e=this;setTimeout(function(){e.focus()},1e3)}}),"function"!=typeof Number.prototype.getDecimals&&(Number.prototype.round=function(e){var t=e||0,n=this.toString().split("."),a=n[0],r="";return n[1]&&t>0&&(r="."+n[1].substr(0,t)),parseFloat(a+r)}),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(e){return 0==this.indexOf(e)}),"function"!=typeof Number.prototype.round&&(Number.prototype.round=function(e){for(var t=this||0,n="1",a=e||0,r=0;a>r;r++)n+="0";return n=parseInt(n),Math.round(parseFloat(t)*n)/n}),"function"!=typeof String.prototype.toFloat&&(String.prototype.toFloat=function(e){var t=parseFloat(this);return t||e||0}),"function"!=typeof String.prototype.toInt&&(String.prototype.toInt=function(e){var t=parseInt(this);return t||e||0}),"function"!=typeof String.prototype.toShortDate&&(String.prototype.toShortDate=function(){var e=new Date(this.toString()+"T06:00:00"),t=e.getFullYear(),n=e.getMonth()+1,a=e.getDate();return a=1==a.toString().length?"0"+a:a,n=1==n.toString().length?"0"+n:n,a+"-"+n+"-"+t}),"function"!=typeof Date.prototype.toShortDate&&(Date.prototype.toShortDate=function(){return this.toString().toShortDate()})}function utilerias(){function e(){C--,0==C&&g()}function t(e){try{var t=e.tipo_proc||"error";null==e.info&&(e.info=Object());var n=Object();void 0!==app.views.main&&(n=_.pick(app.views.main.user,"clave","idPlantel","idUsuario","nombre","tipo","usuario"));var a={errmsg:e.info.errmsg,errnum:e.info.errnum,user:n,url:e.url,data:e.info.data,proc:e.info.proc,tipo:e.tipo,xhrErr:e.xhr?e.xhr.statusText:""};Rollbar[t](a)}catch(r){}}function n(e){for(var t=e.split("}"),n=Object(),a=0;a<t.length;a++)if(0!=t[a].length){var r=t[a].split("{");2==r.length&&(n[r[0].trim()]="-webkit-print-color-adjust: exact;"+r[1].replace(/\s/gi,""))}return n}function a(e){function t(e){console.log(e)}function n(e){g.click()}function a(e){e&&f.attr("src",url_imgs+e)}var r=e.idPk,o=e.elem,i=e.xpath,s=1==e.custom?1:0,l=e.done||t,c=e.auto||!1,u=e.type||"image",d=o.data("upField"),p=app.templates.upload({field:d,type:u});o.html(p);var f=o.find("img"),g=o.find('input[type="file"]'),m=u;switch(f.attr("src",url_assets+"file.png"),e.type){case"excel":m=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel";break;case"text":m=".txt";break;default:m="image/*",f.attr("src",url_assets+"usuario_annon.jpg")}g.attr("accept",m),c&&f.off("click").on("click",function(e){e.stopPropagation(),g.click()}),g.off("click").on("click",function(e){e.stopPropagation()}),g.off("change").on("change",function(){var e=URL.createObjectURL(this.files[0]),t=0;t="function"==typeof r?r():r;var n="/configuraciones/upload/"+i+t+"/"+s,a=g.clone(!0),o=$('<form enctype="multipart/form-data"></form>').append(g);jData=new FormData(o[0]),g=a;var c=null;c=$.ajax({url:n,type:"POST",data:jData,success:function(t){"image"==u?f.attr("src",e):app.ut.message({text:"Archivo subido correctamente.",tipo:"success"}),l(t)},dataType:"json",cache:!1,contentType:!1,processData:!1}),c.always(function(){})});var v={upload:n,setUrl:a};o.data("fn",v)}function r(e){function t(e){var t=e[i];t&&l.data("old","")}function n(){l.attr("src","").data("old","")}function a(){return l.data("old")}function r(e){l.data("old")||l.data("old",l.attr("src")),l.attr("src",url_imgs+e)}var o=e.elem,i=o.data("field"),s=app.templates.upload({field:i});o.html(s);var l=o.find("img"),c=o.find('input[type="file"]');c.on("change",function(){readURL(this,l)});var u={clean:n,getUrl:a,setUrl:r,updateUrl:t};o.data("fn",u)}function o(e,n){var a="alert";if(e.errmsg&&e.errmsg.length>0){try{Rollbar&&t({info:e,tipo:"handleErr",url:app.currView.url})}catch(r){}var o="";switch(e.errmsg){case"ORA-01403: no data found":o="No hay datos que mostrar",a="primary";break;default:o=e.errmsg}return app.ut.message({text:o,tipo:a}),!1}return n||app.ut.message({text:"Registro guardado correctamente",tipo:"success"}),!0}function i(n){function a(e){try{Rollbar&&e.errmsg&&e.errmsg.length>0&&(e.data=m,t({info:e,tipo:"ajax",url:app.currView.url}))}catch(n){}u(e)}function r(e){console.log(e)}function o(e,n,a){try{Rollbar&&c.errmsg&&c.errmsg.length>0&&(c.data=m,t({info:c,tipo:"ajax",url:app.currView.url}))}catch(r){}console.log(e),fueraDeServicio()}function i(){console.log("finish"),e()}var s=n.url,l=n.type||"GET",c=n.data||{},u=n.done||r,d=n.err||o,p=n.dataType||"json",f=n.loading||!1,g=n.form||null;C++,E||y();var m=c,v="application/json",h=null;g?(h=new FormData(g[0]),h.append("data",JSON.stringify(c)),v=!1):h=JSON.stringify(c);var w=null;w="GET"==l?$.get(s,c):$.ajax({url:s,type:l,data:h,dataType:p,cache:!1,contentType:v,processData:!1}),w.done(a).fail(d).always(i),f&&y()}function s(){$("#loading").fadeOut(function(){$(this).addClass("isHidden")})}function l(e){var t=e.text||"",n=void 0===e.auto_close?!1:e.auto_close,a=e.time||2e3,r=e.tipo||"alert",o=$(app.templates.alerta({texto:t,tipo:r}));$.fx.speeds.slow=a,$(".pnlAlert").prepend(o).foundation(),n&&o.fadeOut("slow",function(){o.find(".close").click()})}function c(e){function t(){a.off("close"),r.done&&"function"==typeof r.done&&r.done(a),a.data("close")&&a.foundation("reveal","close")}function n(e){r.cancel&&"function"==typeof r.cancel&&(r.cancel(),a.off("close")),"close"!=e.type&&a.foundation("reveal","close")}var a=e.el||$("#popConfirmacion"),r=e||{},o=r.header||"Confirmar",i=r.body||"/",s=r.dataID||0;a.data("close",!0),a.find(".pop-head label").text(o),a.find(".pop-body").html(i),a.find(".btn-aceptar").removeData().data("idKey",s).off("click").on("click",t),a.find(".btn-cancelar").off("click").on("click",n),a.off("close").on("close",n),a.foundation("reveal","open")}function u(e){var t,n,a,r;r=Math.floor(e/1e3),a=Math.floor(r/60),r%=60,n=Math.floor(a/60),a%=60,t=Math.floor(n/24),n%=24,this.days=t,this.hours=n,this.minutes=a,this.seconds=r}function d(e){function t(e){o(e,s)}function n(e,t){console.log(e),t()}function a(e,t,n){console.log(e),u&&s()}var r=e.url||"/PVenta",o=e.done||n,i=e.err||a,l=e.type||"text",c=e.data||{},u=void 0===e.loading?!0:e.loading;u&&show(),$.get(r,c,l).done(t).fail(i)}function p(e){function t(e){r(e),a()}function n(e,t){o(e,t),a()}function a(){C--,0==C&&g()}C++,E||y();var r=e.done||b,o=e.fail||b,i=$.getJSON(e.url);return i.done(t).fail(n),i}function f(){var e=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];return e}function g(e,t){E=!1,T.fadeOut()}function m(e){var t=e.text||"",n=e.time||2e3,a=e.tipo||"alert",r=$(app.templates.alerta({texto:t,tipo:a}));$.fx.speeds.slow=n,$(".pnlAlert").prepend(r),r.fadeOut("slow",function(){r.find(".close").click()})}function v(e){function t(){a.off("close"),window.print(),a.foundation("reveal","close")}function n(e){a.off("close"),"close"!=e.type&&a.foundation("reveal","close")}var a=e.el||$("#popImprimir"),r=e.body||"/",o=e["class"]||"";$("#print-area").removeClass().addClass(o).html(r),a.find("#modal-body").removeClass().addClass(o).html(r),a.find("#btnImprimir").off("click").on("click",t),a.find("#btnCancelar").off("click").on("click",n),a.off("close").on("close",n),a.foundation("reveal","open")}function h(e){function t(e){if(i=e.currentTarget.value,s==i)clearTimeout(l);else{if(13==e.keyCode)return clearTimeout(l),void n();null!=l&&clearTimeout(l),l=setTimeout(n,o)}}function n(){s=i,r(i),l=null}var a=e.elem,r=e.done,o=e.timeout||1e3,i="",s="",l=null;a.on("keyup",t)}function y(){var e=$(document).height(),t=$("body").height(),n=$("html").height(),a=0;a=e>t&&e>n?e:t>n?t:n;var r=$(document).scrollTop()+250;E=!0,T.css({height:a+"px"}).fadeIn().children("#topLoader").css({top:r+"px"})}function w(e){function t(e){switch(e){case 1:return"UN";case 2:return"DOS";case 3:return"TRES";case 4:return"CUATRO";case 5:return"CINCO";case 6:return"SEIS";case 7:return"SIETE";case 8:return"OCHO";case 9:return"NUEVE"}return""}function n(e){switch(decena=Math.floor(e/10),unidad=e-10*decena,decena){case 1:switch(unidad){case 0:return"DIEZ";case 1:return"ONCE";case 2:return"DOCE";case 3:return"TRECE";case 4:return"CATORCE";case 5:return"QUINCE";default:return"DIECI"+t(unidad)}case 2:switch(unidad){case 0:return"VEINTE";default:return"VEINTI"+t(unidad)}case 3:return a("TREINTA",unidad);case 4:return a("CUARENTA",unidad);case 5:return a("CINCUENTA",unidad);case 6:return a("SESENTA",unidad);case 7:return a("SETENTA",unidad);case 8:return a("OCHENTA",unidad);case 9:return a("NOVENTA",unidad);case 0:return t(unidad)}}function a(e,n){return n>0?e+" Y "+t(n):e}function r(e){switch(centenas=Math.floor(e/100),decenas=e-100*centenas,centenas){case 1:return decenas>0?"CIENTO "+n(decenas):"CIEN";case 2:return"DOSCIENTOS "+n(decenas);case 3:return"TRESCIENTOS "+n(decenas);case 4:return"CUATROCIENTOS "+n(decenas);case 5:return"QUINIENTOS "+n(decenas);case 6:return"SEISCIENTOS "+n(decenas);case 7:return"SETECIENTOS "+n(decenas);case 8:return"OCHOCIENTOS "+n(decenas);case 9:return"NOVECIENTOS "+n(decenas)}return n(decenas)}function o(e,t,n,a){return cientos=Math.floor(e/t),resto=e-cientos*t,letras="",cientos>0&&(cientos>1?letras=r(cientos)+" "+a:letras=n),resto>0&&(letras+=""),letras}function i(e){return divisor=1e3,cientos=Math.floor(e/divisor),resto=e-cientos*divisor,strMiles=o(e,divisor,"MIL","MIL"),strCentenas=r(resto),""==strMiles?strCentenas:strMiles+" "+strCentenas}function s(e){return divisor=1e6,cientos=Math.floor(e/divisor),resto=e-cientos*divisor,strMillones=o(e,divisor,"UN MILLON","MILLONES"),strMiles=i(resto),""==strMillones?strMiles:strMillones+" "+strMiles}function l(e){var t={numero:e,enteros:Math.floor(e),centavos:Math.round(100*e)-100*Math.floor(e),letrasCentavos:"",letrasMonedaPlural:"PESOS",letrasMonedaSingular:"PESO"};return t.centavos>0?t.letrasCentavos="CON "+t.centavos+"/100 M.N.":t.letrasCentavos="CON 00/100 M.N.",0==t.enteros?"CERO "+t.letrasMonedaPlural+" "+t.letrasCentavos:1==t.enteros?s(t.enteros)+" "+t.letrasMonedaSingular+" "+t.letrasCentavos:s(t.enteros)+" "+t.letrasMonedaPlural+" "+t.letrasCentavos}return l(e)}function S(e){function t(){d.data("current",null).val(""),k.find(".tya-clear").css({display:"none"}),C()}function n(e){var t=null;return e&&d.data("current")?t=d.data("current")[e]||null:e||(t=d.data("current")||null),t}function a(e){console.log("on selected")}function r(e){console.log("on clean")}function o(){O&&clearTimeout(O),i()}function i(){function e(){k.find(".tya-loading").css({display:"none"}),console.log("fin"),N=null,O=null}function t(e,t){v(e,t)}function n(e){0==e.data.length&&app.ut.message({text:"No se encontraron datos en la busqueda",tipo:"primary"}),h(e.data,x,f)}k.find(".tya-loading").css({display:"inline-block"}),console.log("init");var a=[];if(w)for(var r=0;r<w.length;r++){var o={field:w[r].field,to:"v"};"u"==w[r].to?o.to="u":"function"==typeof w[r].value?o.value=w[r].value(d):o.value=w[r].value,a.push(o)}else a=null;$.get("/controles/tya/"+p,{query:N,filters:y,where:a,sorts:S,custom:T,displayKey:f,def:g}).done(n).fail(t).always(e)}function s(){var e=new Bloodhound({datumTokenizer:function(e){return Bloodhound.tokenizers.whitespace(e.dKey)},queryTokenizer:Bloodhound.tokenizers.whitespace,local:u});return e.initialize(),e.ttAdapter()}function l(e,t){N=e,x=t,console.log(e),O&&clearTimeout(O),O=setTimeout(i,I)}function c(e,t,n){for(var a=0;a<e.length;a++)e[a].dKey=e[a][n];t(e)}var u=e.arr||[],d=e.elem,p=e.url||"",f=e.dKey||"nombre",g=e.def||"select",m=e.tmp||app.templates.tyaTmp,v=e.fail||b,h=e.done||c,y=e.filters||[{filter:"nombre"}],w=e.where||null,S=e.sorts||null,T=e.custom||null,E=e.onSelected||a,C=e.onClean||r,O=null,N=null,x=null,I=1e3,M=p.length>0?l:s();d=d.typeahead(null,{name:"familias",displayKey:f,source:M,templates:{suggestion:m}}).data("dKey",f).on("typeahead:selected typeahead:autocompleted",function(e,t){var n=$(e.currentTarget);n.data("current",t).val(t[n.data("dKey")]),console.log(t),E(t)}).on("blur",function(e){var t=$(e.currentTarget);if(t.data("current")){if(t.data("current").nombre!=t.val()){var n=t.data("current");t.val(n.dKey)}k.find(".tya-clear").css({display:"inline-block"})}else t.val(""),k.find(".tya-clear").css({display:"none"})}),1==d.parents("label").length&&1==d.parents("label").next("small").length&&d.parents(".twitter-typeahead").append(d.parents("label").next("small"));var k=d.parents(".twitter-typeahead");k.find(".tt-hint").attr("readonly","readonly").remove(),k.append('<i class="icon-cross tya-clear"></i>'),k.append('<i class="icon-spinner tya-loading icon-spin"></i>'),k.on("click",".tya-clear",function(){t()});var D={execQuery:o,clean:t,current:n};return d.data("fn",D),D}function b(e){console.log(e)}var T=$(".loading"),E=!1,C=0;return{alerta:m,confirm:c,datediff:u,get:d,getJson:p,hide:g,handleErr:o,logging:t,meses:f(),message:l,print:v,request:i,search:h,show:y,stringToCss:n,toWords:w,tyAhead:S,upload:r,uploadRemote:a}}function loadAsync(e,t){app.ut.show(),app.currView.close();for(var n=t||[],a=["/templates/views/"+e+".js?bust="+bust],r=0;r<n.length;r++)a.push("/templates/views/"+n[r]+".js?bust="+bust);var o=$.Deferred();return app.views[e]?(app.currView=app.views[e],app.currView.render(),o.resolve(app.currView),app.ut.hide()):$.get("/template/find/"+e).done(function(t){app.views.noAccess&&"-1"==t?(app.currView=app.views.noAccess,app.currView.render()):(0==t.length&&fueraDeServicio(),"-1"==t?(e="noAccess",a=["/templates/views/noAccess.js"],load_content.append(app.views.main.tmp_frm_noaccess({}))):load_content.append(t),require(a,function(t){app.currView=app.views[e]||(app.views[e]=new t.view),app.currView.render(),app.currView.$el.foundation(),o.resolve(app.currView)}))}).fail(function(e){o.reject()}).always(function(){app.ut.hide()}),o.then(function(e){}),o.promise}var bust=(new Date).getTime(),load_content=null,url_imgs="images/db_imgs/",url_assets="images/",app={views:{},loadAsync:loadAsync,ut:new utilerias,templates:{},controles:{},models:{},collections:{},servicios:{},currView:{close:function(){},$el:$("div")},socket:{}};define(["js/base/router.js"],function(e){return bases(),Handlebars.registerHelper("GetGlFecha",function(e){if(!e)return"";if(-1==e.search(/[a-zA-Z]+/)){var t=e.split("-");e=t[2]+"-"+t[1]+"-"+t[0]}var e=new Date(e.toString()),n=e.getDate().toString(),a=(parseInt(e.getMonth().toString())+1).toString(),r=e.getFullYear().toString();return e=(1==n.length?"0"+n:n)+"-"+(1==a.length?"0"+a:a)+"-"+r}),$.ajaxSetup({cache:!1}),load_content=$("#load_content"),app.router=new e,Backbone.history.start({root:"/"}),window.app=app,app});